# Ghidra hexagon plugin

WIP Hexagon decompiler plugin for ghidra

![demo](./screenshot-fact.png)

Pcode is more or less autogenerated, essentially copying and adapting from
[binja-hexagon](https://github.com/google/binja-hexagon)

# Known issues

### Low-level Error: Overlapping input varnodes

This frustrating error causes decompilation to fail after autoanalysis. I
haven't root caused this, but the issue is caused by an exception in
ActionInputPrototype. 

A temporary fix is to recompile the decompiler with this patch

```diff
diff --git a/Ghidra/Features/Decompiler/src/decompile/cpp/coreaction.cc b/Ghidra/Features/Decompiler/src/decompile/cpp/coreaction.cc
index ae0b1c3a3..caf761204 100644
--- a/Ghidra/Features/Decompiler/src/decompile/cpp/coreaction.cc
+++ b/Ghidra/Features/Decompiler/src/decompile/cpp/coreaction.cc
@@ -5263,7 +5263,7 @@ void ActionDatabase::universalAction(Architecture *conf)
   act->addAction( new ActionHideShadow("merge") );
   act->addAction( new ActionCopyMarker("merge") );
   act->addAction( new ActionOutputPrototype("localrecovery") );
-  act->addAction( new ActionInputPrototype("fixateproto") );
+  // act->addAction( new ActionInputPrototype("fixateproto") );
   act->addAction( new ActionRestructureHigh("localrecovery") );
   act->addAction( new ActionMapGlobals("fixateglobals") );
   act->addAction( new ActionDynamicSymbols("dynamic") );
```

Make sure the changes stick by running

```
gradle buildNatives
```

Then set the function arguments manually by reading the function. Once the
arguments to the function are explicitly set, ActionInputPrototype
short-circuits so you can safely re-enable the patch.

### Spurious `CALL_RETURN` flow override

Some analyzer aggressively inserts the `CALL_RETURN` flow override, which
appears like this in the listing:

```
c04f4040 22 58 67 5b  {  J2_call    FUN_c002f084
                     -- Flow Override: CALL_RETURN (CALL_TERMINATOR)
```

I get around this by disabling the "Non-returning Functions - Discovered"
analyzer during auto-analysis

### Exception while decompiling XXX: Decompiler process died

More often than not this is caused by pcode being unimplemented for some
instruction. To view pcode for an instruction, go into the listing view, click
on the "Edit the listing fields" icon in the top right, right click on PCode,
and click on "Enable field"

```
e6 40 41 8c  {  S2_vsplatrb   R6 R1
                                     UNIMPLEMENTED

```

You can work around this temporarily by creating a userop

```diff
diff --git a/Ghidra/Processors/Hexagon/data/languages/hexagon.slaspec b/Ghidra/Processors/Hexagon/data/languages/hexagon.slaspec
index 57d1d31bf..e89ed1dac 100644
--- a/Ghidra/Processors/Hexagon/data/languages/hexagon.slaspec
+++ b/Ghidra/Processors/Hexagon/data/languages/hexagon.slaspec
@@ -144,6 +144,7 @@ define pcodeop fICDATAW;
 define pcodeop fPAUSE;
 define pcodeop WRITE_SGP0;
 define pcodeop fSTORE_LOCKED;
+define pcodeop S2_vsplatrb;

 define token NORMAL(32)
   Parse                                = (14, 15)
@@ -34376,7 +34377,9 @@ C4_addipc_pkt_start: reloc is epsilon [ reloc = pkt_start; ] {

 :S2_vsplatrh S2_vsplatrh_Rdd32 S2_vsplatrh_Rs32 is phase = 1 & immext = 0xffffffff & Parse != 0b00 & subinsn = 0 & b6 = 1 & b7 = 0 & b22 = 1 & b23 = 0 & b24 = 0 & b25 = 0 & b26 = 1 & b27 = 0 & b28 = 0 & b29 = 0 & b30 = 0 & b31 = 1 & S2_vsplatrh_Rdd32 & S2_vsplatrh_Rs32 unimpl

-:S2_vsplatrb S2_vsplatrb_Rd32 S2_vsplatrb_Rs32 is phase = 1 & immext = 0xffffffff & Parse != 0b00 & subinsn = 0 & b5 = 1 & b6 = 1 & b7 = 1 & b21 = 0 & b22 = 1 & b23 = 0 & b24 = 0 & b25 = 0 & b26 = 1 & b27 = 1 & b28 = 0 & b29 = 0 & b30 = 0 & b31 = 1 & S2_vsplatrb_Rd32 & S2_vsplatrb_Rs32 unimpl
+:S2_vsplatrb S2_vsplatrb_Rd32 S2_vsplatrb_Rs32 is phase = 1 & immext = 0xffffffff & Parse != 0b00 & subinsn = 0 & b5 = 1 & b6 = 1 & b7 = 1 & b21 = 0 & b22 = 1 & b23 = 0 & b24 = 0 & b25 = 0 & b26 = 1 & b27 = 1 & b28 = 0 & b29 = 0 & b30 = 0 & b31 = 1 & S2_vsplatrb_Rd32 & S2_vsplatrb_Rs32 {
+    S2_vsplatrb(S2_vsplatrb_Rd32, S2_vsplatrb_Rs32);
+}

 :S6_vsplatrbp S6_vsplatrbp_Rdd32 S6_vsplatrbp_Rs32 is phase = 1 & immext = 0xffffffff & Parse != 0b00 & subinsn = 0 & b6 = 0 & b7 = 1 & b22 = 1 & b23 = 0 & b24 = 0 & b25 = 0 & b26 = 1 & b27 = 0 & b28 = 0 & b29 = 0 & b30 = 0 & b31 = 1 & S6_vsplatrbp_Rdd32 & S6_vsplatrbp_Rs32 unimpl
```
